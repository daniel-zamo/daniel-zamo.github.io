---
title: "Stack LAMP con Ansible & Docker"
description: Despliegue automatizado de arquitectura web con gesti√≥n de secretos, construcci√≥n de im√°genes personalizadas y workflow estandarizado.
sidebar:
  label: Stack LAMP (Web)
  order: 2
type: project
domain: automation
tags: ["ansible", "docker", "lamp", "mysql", "security", "make"]
---

import { Steps } from '@astrojs/starlight/components';

## üìã Resumen Ejecutivo

Este proyecto moderniza el despliegue de aplicaciones PHP (Legacy), evolucionando de una configuraci√≥n manual a una **Infraestructura Inmutable**. A diferencia de los despliegues b√°sicos de contenedores, esta soluci√≥n aborda problemas del mundo real: la necesidad de compilar extensiones de PHP personalizadas (`mysqli`), la gesti√≥n segura de credenciales fuera del c√≥digo y la estandarizaci√≥n del entorno de desarrollo.

### üéØ Objetivos de Ingenier√≠a
1.  **Inmutabilidad:** Construcci√≥n de im√°genes Docker personalizadas (*custom builds*) en tiempo de despliegue para inyectar dependencias del sistema.
2.  **Seguridad (12-Factor App):** Desacoplamiento total de credenciales. El c√≥digo fuente no contiene secretos; estos se inyectan como variables de entorno.
3.  **Estandarizaci√≥n:** Implementaci√≥n de un `Makefile` como wrapper para abstraer la complejidad de Python/Ansible y facilitar el *onboarding*.

---

## üèóÔ∏è Arquitectura de la Soluci√≥n

El dise√±o implementa un patr√≥n de **Build & Deploy Remoto** orquestado por Ansible. El nodo de control prepara la configuraci√≥n y los secretos, mientras que el host remoto construye y ejecuta los contenedores.

```mermaid
graph LR
    %% --- Definici√≥n de Estilos ---
    classDef ansibleNode fill:#fff9c4,stroke:#fbc02d,stroke-width:2px,color:#000000;
    classDef dockerNode fill:#e0f7fa,stroke:#0288d1,stroke-width:2px,color:#000000;
    classDef secretNode fill:#ffcdd2,stroke:#c62828,stroke-width:2px,color:#000000;

    subgraph Control_Node ["Nodo de Control (Dev)"]
        style Control_Node fill:#eceff1,stroke:#cfd8dc,color:#000000
        Make[("Makefile Wrapper")]:::ansibleNode
        Ansible[("Ansible Playbook")]:::ansibleNode
        Secrets[("secrets.yml<br/>(GitIgnored)")]:::secretNode
        
        Make --> Ansible
        Secrets -.-> Ansible
    end

    subgraph Remote_Host ["Servidor de Aplicaciones (Ubuntu 24.04)"]
        style Remote_Host fill:#0288d1,stroke:#cfd8dc,stroke-width:2px,color:#000000
        
        subgraph Docker_Runtime ["Docker Engine"]
            style Docker_Runtime fill:#eceff1,stroke:#455a64,color:#000000
            
            Build[("Docker Build<br/>(PHP + Mysqli)")]:::dockerNode
            App[("Container Web<br/>Apache")]:::dockerNode
            DB[("Container DB<br/>MariaDB")]:::dockerNode
            
            Ansible -- "1. Upload Dockerfile" --> Build
            Build -- "2. Image Created" --> App
            Ansible -- "3. Inject ENV Vars" --> App
            App -- "Internal DNS" --> DB
        end
    end
    
    linkStyle default stroke:#333,stroke-width:2px,fill:none;
```

---

## üíª Implementaci√≥n T√©cnica

La soluci√≥n utiliza una estructura profesional que separa configuraci√≥n, secretos y l√≥gica de despliegue.

<Steps>

1.  **Wrapper de Ejecuci√≥n (Makefile)**

    Para evitar problemas de versiones y entornos virtuales, encapsulamos los comandos en un `Makefile`. Esto garantiza que cualquier desarrollador use las mismas herramientas.

    ```makefile title="Makefile"
    setup:
        python3 -m venv .venv
        .venv/bin/pip install ansible-core docker
        .venv/bin/ansible-galaxy install -r requirements.yml

    deploy:
        .venv/bin/ansible-playbook playbook/deploy-lamp.yml
    ```

2.  **Gesti√≥n de Secretos (Patr√≥n de Sobreescritura)**

    Ansible carga primero las variables p√∫blicas (`all.yml`) y luego sobreescribe con un archivo de secretos local que est√° excluido de Git (`.gitignore`).

    ```yaml title="playbook/deploy-lamp.yml"
    - hosts: app_servers
      vars_files:
        - "../group_vars/all.yml"      # Estructura p√∫blica (Placeholders)
        - "../group_vars/secrets.yml"  # Secretos locales (Real Passwords)
    ```

3.  **L√≥gica del Playbook (Build & Run)**

    El playbook no solo descarga im√°genes, sino que sube un `Dockerfile` y compila una imagen personalizada para soportar `mysqli`.

    ```yaml title="playbook/deploy-lamp.yml"
    tasks:
      - name: Construir imagen PHP personalizada
        community.docker.docker_image:
          name: "{{ custom_image_name }}"
          tag: latest
          build:
            path: "{{ remote_project_path }}" # Ruta remota del Dockerfile
          source: build
          force_source: true

      - name: Desplegar Web Container
        community.docker.docker_container:
          name: "{{ project_name }}-web"
          image: "{{ custom_image_name }}:latest" # Usamos la imagen reci√©n creada
          env:
            # Inyecci√≥n segura de variables de entorno
            DB_HOST: "{{ project_name }}-db"
            DB_USER: "{{ mysql_user }}"
            DB_PASSWORD: "{{ mysql_pass }}"
    ```

4.  **C√≥digo Agn√≥stico (PHP)**

    El c√≥digo fuente (`src/index.php`) no contiene ninguna credencial. Lee la configuraci√≥n del entorno, cumpliendo con los principios de *The Twelve-Factor App*.

    ```php title="src/index.php"
    <?php
    // Lectura segura desde variables de entorno
    $servername = getenv('DB_HOST');
    $username = getenv('DB_USER');
    $password = getenv('DB_PASSWORD');

    $conn = new mysqli($servername, $username, $password, $dbname);
    
    if ($conn->connect_error) {
        die("‚ùå Fallo de conexi√≥n: " . $conn->connect_error);
    }
    echo "‚úÖ Conectado exitosamente a MariaDB.";
    ?>
    ```

5.  **Ejecuci√≥n Estandarizada**

    Gracias al Makefile, el despliegue se reduce a dos comandos, independientemente de la complejidad subyacente.

    ```bash
    # Inicializaci√≥n (Solo la primera vez)
    make setup

    # Despliegue idempotente
    make deploy
    ```

</Steps>

## üîç An√°lisis de Valor

| Caracter√≠stica | Script Bash Tradicional | Ansible + Docker Pro |
| :--- | :--- | :--- |
| **Credenciales** | Hardcoded en archivos (`.php`) | Inyectadas en Memoria (ENV) |
| **Dependencias** | Instalaci√≥n manual (`apt-get`) | Docker Build Autom√°tico |
| **Portabilidad** | "Funciona en mi m√°quina" | Estandarizado v√≠a Makefile |

### Pr√≥ximos Pasos (Roadmap AZ-104)

Este proyecto sirve como base para la migraci√≥n a la nube. Hemos documentado este proceso en la secci√≥n de Operaciones Cloud:

1. **Migraci√≥n IaaS:** Replicar esta arquitectura utilizando M√°quinas Virtuales en Azure.
    - **[üëâ Ver Escenario 01: Migraci√≥n LAMP a Azure IaaS](/es/az-cloud-ops/compute/scenario-01-lamp-iaas/)**
    
2. **Azure Container Registry (ACR):** Mover el proceso de *build* a la nube.
3. **Azure Key Vault:** Gesti√≥n de secretos centralizada.
