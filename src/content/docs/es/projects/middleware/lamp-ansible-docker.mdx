---
title: "Stack LAMP con Ansible & Docker"
description: Despliegue automatizado de arquitectura web (Apache, MySQL, PHP) usando contenedores y orquestaci√≥n IaC.
sidebar:
  label: Stack LAMP (Web)
  order: 2
type: project
domain: automation
tags: ["ansible", "docker", "lamp", "mysql", "iac"]
---

import { Steps } from '@astrojs/starlight/components';

## üìã Resumen Ejecutivo

Este proyecto aborda la necesidad de estandarizar el despliegue de aplicaciones web basadas en PHP (Legacy) en un entorno moderno. En lugar de configurar servidores manualmente, utilizamos **Ansible** para definir el estado deseado de la infraestructura y **Docker** para encapsular las dependencias de la aplicaci√≥n.

### üéØ Objetivos de Ingenier√≠a
1.  **Idempotencia:** Capacidad de ejecutar el despliegue m√∫ltiples veces sin duplicar recursos ni generar errores.
2.  **Segregaci√≥n de Red:** Aislamiento de la base de datos (Backend) del servidor web (Frontend) mediante redes bridge privadas.
3.  **Persistencia:** Gesti√≥n de vol√∫menes Docker para garantizar la durabilidad de los datos de MySQL.

---

## üèóÔ∏è Arquitectura de la Soluci√≥n

El dise√±o implementa un patr√≥n de **Sidecar de Datos** y segregaci√≥n de contenedores gestionados por un controlador externo (Ansible).

```mermaid
graph TD
    classDef ansibleNode fill:#fff9c4,stroke:#fbc02d,stroke-width:2px,color:#000000;
    classDef dockerNode fill:#e0f7fa,stroke:#0288d1,stroke-width:2px,color:#000000;
    classDef dbNode fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000000;
    classDef extNode fill:#37474f,stroke:#000000,stroke-width:2px,color:#ffffff;

    subgraph Host ["Host Docker (Ubuntu 24.04)"]
        style Host fill:#0288d1,stroke:#cfd8dc,stroke-width:2px,color:#ffffff

        subgraph Ansible_Playbook ["Ansible Automation"]
            style Ansible_Playbook fill:#546e7a,stroke:#fff,stroke-width:1px,color:#fff
            direction TB
            Task1["1. Configura Red"]:::ansibleNode
            Task2["2. Provisiona Vol√∫menes"]:::ansibleNode
            Task3["3. Despliega MySQL"]:::ansibleNode
            Task4["4. Despliega Apache/PHP"]:::ansibleNode
        end

        subgraph Docker_Runtime ["Runtime de Contenedores"]
            style Docker_Runtime fill:#eceff1,stroke:#455a64,stroke-width:2px,color:#000000
            Net["Red Privada: lamp-network"]:::dockerNode
            DB[("Contenedor DB<br/>MariaDB 10.6")]:::dbNode
            Web["Contenedor Web<br/>Apache + PHP 8.1"]:::dockerNode
            Ext["Tr√°fico Externo"]:::extNode
            
            Vol1[("Volumen: db_data")]:::dbNode --> DB
            Web -- "Puerto 3306" --> DB
            Web -- "Puerto 80:80" --> Ext
            
            Task1 -.-> Net
            Task2 -.-> Vol1
            Task3 -.-> DB
            Task4 -.-> Web
        end
    end
    linkStyle default stroke:#333,stroke-width:2px,fill:none;
```

---

## üíª Implementaci√≥n T√©cnica (Ansible)

La l√≥gica de despliegue se organiza siguiendo el est√°ndar **SOP-LINUX-ANS-01**, separando inventarios, playbooks y c√≥digo fuente.

<Steps>

1.  **Configuraci√≥n del Motor (Ansible Core)**

    Debido a cambios recientes en las colecciones comunitarias, utilizamos una configuraci√≥n minimalista para garantizar compatibilidad con Python 3.12+.

    ```ini title="ansible.cfg"
    [defaults]
    inventory = ./inventory/dev
    collections_path = ./collections
    host_key_checking = False
    pipelining = True
    # Usamos 'yaml' (short name) para evitar conflictos con plugins legacy
    stdout_callback = yaml

    [privilege_escalation]
    become = True
    become_method = sudo
    become_user = root
    become_ask_pass = False
    ```

    Declaramos √∫nicamente las dependencias estrictamente necesarias para evitar "bloatware" o conflictos.

    ```yaml title="requirements.yml"
    ---
    collections:
      - name: community.docker
        version: 3.10.1
      - name: ansible.posix
        version: 1.5.4
    ```

2.  **Definici√≥n del Inventario**

    ```ini title="inventory/dev"
    [app_servers]
    192.168.1.60 ansible_user=dzamo ansible_ssh_private_key_file=~/.ssh/id_rsa
    ```

3.  **Estructura del Playbook**
    
    > **Nota:** Al ejecutar desde la carpeta `playbooks/`, la ruta al c√≥digo fuente se ajusta a `../src`.

    ```yaml title="playbooks/deploy-lamp.yml"
    ---
    - name: Aprovisionamiento de Stack LAMP
      hosts: app_servers
      become: true
      vars:
        project_name: "intranet-core"
        mysql_root_pass: "SecureRoot123!"
        mysql_db: "intranet_db"
        mysql_user: "app_user"
        mysql_pass: "AppPass2025"
        
      tasks:
        - name: Crear Red Docker Aislada
          community.docker.docker_network:
            name: "{{ project_name }}-net"
            driver: bridge

        - name: Crear Volumen de Persistencia DB
          community.docker.docker_volume:
            name: "{{ project_name }}-db-data"

        - name: Desplegar Base de Datos (MariaDB)
          community.docker.docker_container:
            name: "{{ project_name }}-db"
            image: mariadb:10.6
            state: started
            restart_policy: always
            networks:
              - name: "{{ project_name }}-net"
            env:
              MARIADB_ROOT_PASSWORD: "{{ mysql_root_pass }}"
              MARIADB_DATABASE: "{{ mysql_db }}"
              MARIADB_USER: "{{ mysql_user }}"
              MARIADB_PASSWORD: "{{ mysql_pass }}"
            volumes:
              - "{{ project_name }}-db-data:/var/lib/mysql"
            labels:
              com.role: "database"

        - name: Desplegar Servidor Web (Apache+PHP)
          community.docker.docker_container:
            name: "{{ project_name }}-web"
            image: php:8.1-apache
            state: started
            restart_policy: always
            ports:
              - "80:80"
            networks:
              - name: "{{ project_name }}-net"
            volumes:
              - ../src:/var/www/html
            labels:
              com.role: "frontend"
    ```

3.  **C√≥digo de la Aplicaci√≥n (Prueba de Concepto)**

    Ubicado en la ra√≠z del proyecto para facilitar su edici√≥n. Inyectamos un script PHP que valida la conexi√≥n DNS interna.

    ```php title="src/index.php"
    <?php
    $servername = "intranet-core-db"; // Resoluci√≥n DNS interna de Docker
    $username = "app_user";
    $password = "AppPass2025";

    // Crear conexi√≥n
    $conn = new mysqli($servername, $username, $password);

    // Verificar
    if ($conn->connect_error) {
        die("‚ùå Fallo de conexi√≥n: " . $conn->connect_error);
    }
    echo "‚úÖ Conectado exitosamente a MariaDB desde Apache Container.";
    ?>
    ```

4.  **Ejecuci√≥n y Verificaci√≥n**

    ```bash
    # Instalaci√≥n de dependencias (Solo la primera vez)
    ansible-galaxy install -r requirements.yml
    
    # Ejecuci√≥n
    ansible-playbook playbooks/deploy-lamp.yml
    ```

</Steps>

## üîç An√°lisis de Valor

La transici√≥n de scripts manuales de Bash a Ansible para este despliegue proporciona:

| Caracter√≠stica | Script Bash Tradicional | Ansible + Docker |
| :--- | :--- | :--- |
| **Control de Estado** | Imperativo (Dif√≠cil saber si fall√≥ a medias) | Declarativo (Asegura el estado final) |
| **Limpieza** | Manual (Riesgo de residuos) | Gesti√≥n nativa del ciclo de vida del contenedor |
| **Portabilidad** | Atado al OS del Host | Ejecutable en cualquier Host con Docker Engine |

### Pr√≥ximos Pasos (Roadmap AZ-104)

Este proyecto sirve como base para la siguiente fase de migraci√≥n a la nube:
1.  **Lift & Shift:** Reutilizar este Playbook para aprovisionar una VM Ubuntu en **Azure Compute**.
2.  **Database Migration:** Desacoplar el contenedor de MariaDB y conectar la App a **Azure Database for MariaDB**.
