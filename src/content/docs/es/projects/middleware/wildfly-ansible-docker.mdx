---
title: "Modernizaci√≥n Middleware: WildFly + Ansible"
description: Implementaci√≥n de una pipeline de Infraestructura como C√≥digo (IaC) para el despliegue inmutable de WildFly, eliminando la deriva de configuraci√≥n en entornos cr√≠ticos.
sidebar:
  label: Orquestaci√≥n WildFly
  order: 1
type: project
domain: automation
tags: ["ansible", "docker", "middleware", "devops", "hardening"]
---

import { Steps, FileTree } from '@astrojs/starlight/components';

## üìã Resumen Ejecutivo

En infraestructuras cr√≠ticas (Banca y Telco), la gesti√≥n tradicional de servidores de aplicaciones basada en *scripts* manuales o "Pets" conlleva riesgos inaceptables: **deriva de configuraci√≥n**, **vulnerabilidades de seguridad** no parcheadas y un **Time-to-Market** lento para nuevas features.

Este proyecto implementa una estrategia de **Modernizaci√≥n de Infraestructura** migrando cargas de trabajo legacy de JBoss/WildFly hacia una arquitectura inmutable basada en contenedores.

### üéØ Objetivos de la Soluci√≥n
*   **Integridad Operacional:** Garantizar que el artefacto desplegado en Desarrollo es bit a bit id√©ntico al de Producci√≥n (Paridad de Entornos).
*   **Seguridad por Dise√±o:** Inyecci√≥n de secretos en tiempo de ejecuci√≥n, evitando credenciales hardcodeadas en archivos XML.
*   **Recuperaci√≥n ante Desastres (DR):** Reducci√≥n del RTO (Recovery Time Objective) de horas a segundos mediante el redespilegue automatizado.

---

## üèóÔ∏è Arquitectura y Decisiones de Dise√±o

La soluci√≥n desacopla el *runtime* (WildFly) de la configuraci√≥n, orquestado por un controlador centralizado.

```mermaid
graph LR
    subgraph Control Plane
    A[Controlador Ansible] 
    end
    
    subgraph Data Plane
    B[Host de Contenedores]
    C(Contenedor WildFly Inmutable)
    end

    A -- "SSH (Playbook IaC)" --> B
    B -- "Spawns" --> C
    C -- "Expone :8080" --> D[Tr√°fico App]
    C -- "Expone :9990" --> E[Tr√°fico Gesti√≥n]
```

### Principios T√©cnicos Aplicados
1.  **Inmutabilidad (Docker):** Se abandonan las actualizaciones "in-place" (yum update). Cada despliegue destruye el contenedor anterior y levanta una versi√≥n limpia y aprobada.
2.  **Idempotencia (Ansible):** El playbook puede ejecutarse N veces sin causar efectos secundarios adversos, garantizando el estado deseado.
3.  **12-Factor App:** La configuraci√≥n espec√≠fica del entorno (usuarios, contrase√±as, memoria JVM) se inyecta v√≠a **Variables de Entorno**, no editando el `standalone.xml`.

---

## üíª Implementaci√≥n T√©cnica

<Steps>

1.  **Definici√≥n del Inventario (IaC)**

    El inventario segrega los entornos, permitiendo aplicar pol√≠ticas diferentes a `staging` y `production` desde una √∫nica base de c√≥digo.

    ```ini title="inventory.ini"
    [middleware_nodes]
    # Nodo objetivo con rol de Host de Contenedores
    192.168.1.50 ansible_user=dzamo ansible_python_interpreter=/usr/bin/python3
    ```

2.  **Playbook de Aprovisionamiento**

    Este artefacto automatiza el ciclo de vida completo. N√≥tese el uso de `restart_policy: always` para resiliencia autom√°tica ante fallos del daemon.

    ```yaml title="deploy-wildfly.yml"
    ---
    - name: Orquestaci√≥n de Stack Middleware (WildFly)
      hosts: middleware_nodes
      become: true
      vars:
        # Versionado estricto para evitar actualizaciones accidentales
        wildfly_tag: "24.0.0.Final"
        container_name: "wildfly-prod-core"
        # En producci√≥n, estos valores vendr√≠an de Ansible Vault
        mgmt_user: "admin_ops"
        mgmt_pass: "{{ vault_mgmt_pass | default('SecurePass123!') }}"

      tasks:
        - name: Verificaci√≥n de Prerrequisitos (Python SDK)
          apt:
            name: python3-docker
            state: present
            update_cache: yes
            cache_valid_time: 3600

        - name: Pull de Imagen Base Aprobada
          community.docker.docker_image:
            name: "quay.io/wildfly/wildfly:{{ wildfly_tag }}"
            source: pull

        - name: Despliegue de Contenedor (Runtime)
          community.docker.docker_container:
            name: "{{ container_name }}"
            image: "quay.io/wildfly/wildfly:{{ wildfly_tag }}"
            state: started
            restart_policy: always
            ports:
              - "8080:8080" # Tr√°fico HTTP
              - "9990:9990" # Consola JBoss CLI
            # Binding a 0.0.0.0 es necesario en contenedores para exposici√≥n externa
            command: /opt/jboss/wildfly/bin/standalone.sh -b 0.0.0.0 -bmanagement 0.0.0.0
            env:
              WILDFLY_USERNAME: "{{ mgmt_user }}"
              WILDFLY_PASSWORD: "{{ mgmt_pass }}"
            labels:
              com.company.env: "production"
              com.company.service: "middleware-core"

        - name: Validaci√≥n de Salud del Servicio (Healthcheck)
          wait_for:
            host: "127.0.0.1"
            port: 9990
            delay: 5
            timeout: 60
    ```

3.  **Ejecuci√≥n y Verificaci√≥n**

    ```bash
    ansible-playbook -i inventory.ini deploy-wildfly.yml
    ```

</Steps>

## üîç An√°lisis de Valor e Impacto

La implementaci√≥n de este flujo automatizado reemplaza un procedimiento manual de **~40 pasos** documentados en Word/Excel, logrando:

| M√©trica | Antes (Manual) | Despu√©s (Automatizado) |
| :--- | :--- | :--- |
| **Tiempo de Aprovisionamiento** | 4 Horas | < 2 Minutos |
| **Error Humano** | Alto Riesgo | Eliminado (Idempotente) |
| **Escalabilidad** | Lineal (1 admin por N servidores) | Exponencial |

### Siguientes Pasos (Roadmap)
*   **Hardening:** Implementaci√≥n de escaneo de vulnerabilidades en la imagen (Trivy/Clair) en el pipeline CI.
*   **Alta Disponibilidad:** Evoluci√≥n hacia un Cl√∫ster JBoss en Modo Dominio utilizando **JGroups con TCPPING** para entornos sin multicast.
