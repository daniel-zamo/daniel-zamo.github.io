---
title: "Balanceo de Carga L7 y Edge Proxy"
description: Implementaci贸n de reglas de Proxy Reverso y algoritmos de distribuci贸n de tr谩fico usando Nginx.
sidebar:
  label: Balanceo de Carga L7
  order: 2
type: scenario
domain: networking
source: manual
---

import { Steps } from '@astrojs/starlight/components';
import LabEnvironment from '../../../../../components/LabEnvironment.astro';

<LabEnvironment />

##  Requisitos de Ingenier铆a

**Contexto de Negocio:**
Las aplicaciones internas legacy alojadas en `web-server01` est谩n expuestas actualmente en puertos no est谩ndar (`1111`, `2222`), complicando las reglas de firewall y el acceso del cliente. Se requiere una soluci贸n de Proxy Reverso para estandarizar el acceso v铆a HTTP.

**Objetivos T茅cnicos:**
1.  **Nodo Objetivo:** `web-server01` (10.0.0.60).
2.  **Redirecci贸n de Tr谩fico (Puerto 8001):**
    *   El tr谩fico entrante debe ser reenviado a la ruta backend espec铆fica: `http://127.0.0.1:2222/special`.
3.  **Balanceo de Carga (Puerto 8000):**
    *   Distribuir tr谩fico entre **App A** (`:1111`) y **App B** (`:2222`).
    *   Algoritmo: Round Robin (Por defecto) o Random.

:::danger[Restricciones Operativas]
*   **Backend Inmutable:** No modifique los archivos de configuraci贸n de Nginx existentes que sirven los puertos 1111/2222.
*   **Persistencia:** La configuraci贸n debe persistir tras un reinicio del sistema.
:::

---

##  Procedimiento de Implementaci贸n

<Steps>

1.  **Acceso al Nodo Objetivo**

    Establezca una conexi贸n segura al servidor web desde el host basti贸n.

    ```bash
    ssh web-server01
    ```

2.  **Verificar Salud del Backend**

    Aseg煤rese de que las aplicaciones upstream est谩n operativas antes de configurar el proxy.

    ```bash
    curl -I http://127.0.0.1:1111
    curl -I http://127.0.0.1:2222
    ```

3.  **Definir Configuraci贸n del Proxy**

    Cree un archivo de configuraci贸n modular en `/etc/nginx/conf.d/`. Evite editar `nginx.conf` directamente.

    ```bash
    sudo vim /etc/nginx/conf.d/loadbalancer.conf
    ```

    Implemente el siguiente bloque para definir el grupo upstream y los contextos server:

    ```nginx title="/etc/nginx/conf.d/loadbalancer.conf"
    # 1. Definir Grupo Upstream (Balanceador)
    upstream backend_apps {
        server 127.0.0.1:1111;
        server 127.0.0.1:2222;
    }

    # 2. Tarea: Balanceador de Carga (Puerto 8000)
    server {
        listen 8000;
        server_name localhost;

        location / {
            proxy_pass http://backend_apps;
        }
    }

    # 3. Tarea: Redirecci贸n/Proxy (Puerto 8001)
    server {
        listen 8001;
        server_name localhost;

        location / {
            proxy_pass http://127.0.0.1:2222/special;
        }
    }
    ```

4.  **Validar y Recargar**

    Realice una comprobaci贸n de sintaxis para prevenir ca铆das del servicio, luego recargue la se帽al del proceso.

    ```bash
    sudo nginx -t
    sudo systemctl reload nginx
    ```

5.  **Verificaci贸n Funcional**

    **Probar Balanceador (8000):** Ejecute m煤ltiples peticiones. Las respuestas deben alternar entre backends.
    ```bash
    for i in {1..4}; do curl http://localhost:8000; echo; done
    ```

    **Probar Redirecci贸n (8001):**
    ```bash
    curl -v http://localhost:8001
    ```

</Steps>

##  Diagn贸stico y Resoluci贸n

*   **Connection Refused:** Aseg煤rese de que Nginx est谩 escuchando en los nuevos puertos:
    ```bash
    ss -tulpn | grep nginx
    ```
*   **502 Bad Gateway:** Indica que Nginx no puede alcanzar los puertos upstream (1111/2222). Verifique si las apps backend han ca铆do.
