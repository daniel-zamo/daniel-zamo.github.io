---
title: "KVM/Libvirt VM Orchestration"
description: Provisioning and lifecycle management of compute instances using virtualization CLI tools.
sidebar:
  label: KVM Orchestration
  order: 4
type: scenario
domain: virtualization
source: manual
---

import { Steps } from '@astrojs/starlight/components';
import LabEnvironment from '../../../../../components/LabEnvironment.astro';

<LabEnvironment />

## üìã Engineering Requirements

**Business Context:**
The QA team requests a dedicated, isolated compute instance on the `kvm-001` hypervisor for integration testing. The environment must be provisioned using standard CLI tools to ensure reproducibility.

**Technical Objectives:**
1.  **Host Readiness:** Validate the `qemu-kvm` and `libvirtd` stack status.
2.  **Storage:** Provision a **10 GiB** `qcow2` volume (Thin Provisioned) named `qa-vm-disk.qcow2`.
3.  **Instance Definition (`qa-vm01`):**
    *   **Specs:** 1 vCPU, 1024 MiB RAM.
    *   **Network:** Default NAT bridge.
    *   **Console:** Serial redirection (Headless mode).
4.  **Lifecycle:** Enable auto-start on boot and perform a graceful shutdown test.

:::note[Scope Constraint]
Full OS installation is not required. Successfully booting the kernel into the installer prompt via the serial console is sufficient for validation.
:::

---

## üîß Implementation Procedure

<Steps>

1.  **Access Hypervisor Node**

    Connect to the virtualization host.

    ```bash
    ssh kvm-001
    ```

2.  **Verify Host Prerequisites**

    Ensure the libvirt daemon is active and enabled.

    ```bash
    sudo systemctl is-active libvirtd
    # If inactive: sudo systemctl enable --now libvirtd
    ```

3.  **Provision Storage Volume**

    Create the virtual disk using `qemu-img`.

    ```bash
    sudo qemu-img create -f qcow2 /var/lib/libvirt/images/qa-vm-disk.qcow2 10G
    ```

4.  **Define and Boot Instance**

    Execute `virt-install` with parameters for a headless environment (`--graphics none`).

    ```bash
    sudo virt-install \
      --name qa-vm01 \
      --ram 1024 \
      --vcpus 1 \
      --disk path=/var/lib/libvirt/images/qa-vm-disk.qcow2,format=qcow2 \
      --os-variant rocky9 \
      --network network=default \
      --graphics none \
      --console pty,target_type=serial \
      --location "https://download.rockylinux.org/pub/rocky/9/BaseOS/x86_64/os/" \
      --extra-args "console=ttyS0"
    ```

    *Tip: To detach from the console without killing the VM, press `Ctrl + ]`.*

5.  **Configure Autostart**

    Ensure the VM survives host reboots.

    ```bash
    sudo virsh autostart qa-vm01
    ```

6.  **Validate Lifecycle Control**

    Verify the VM is running, then request an ACPI shutdown.

    ```bash
    # Check status
    sudo virsh list --all

    # Graceful shutdown request
    sudo virsh shutdown qa-vm01
    ```

</Steps>

## üîç Troubleshooting

*   **"Guest name already in use":** If a previous attempt failed partially, clean up the metadata:
    ```bash
    sudo virsh destroy qa-vm01
    sudo virsh undefine qa-vm01
    ```
*   **Console Hanging:** If the console does not show output, ensure `--extra-args "console=ttyS0"` was passed correctly to redirect kernel logs to the serial port.
