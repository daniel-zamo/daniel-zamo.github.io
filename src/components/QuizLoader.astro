---
// RUTA: src/components/QuizLoader.astro (VERSIÓN FINAL CON SCRIPT ÚNICO)
import { getCollection } from 'astro:content';
import Quiz from './Quiz.astro';
const allQuestions = await getCollection('questions');
---

<div id="quiz-loader-wrapper">
  {allQuestions.map(question => (
    <div id={question.id} class="quiz-instance-wrapper" style="display: none;">
      <Quiz question={question.data} />
    </div>
  ))}
  <div id="quiz-not-found" style="display: none;">
    <h3>Question not found</h3>
    <p>Return to the <a href="/practice/">practice index</a>.</p>
  </div>
</div>

<!-- ESTE ES EL ÚNICO SCRIPT QUE SE EJECUTARÁ EN LA PÁGINA -->
<script>
  function handleQuizSubmit(event) {
    // Nos aseguramos de que solo actuamos si se envía un formulario de quiz
    if (!event.target.matches('.options-form')) {
      return;
    }
    event.preventDefault();
    const form = event.target;

    // Leemos los datos directamente del formulario que se envió
    const correctAnswerId = form.dataset.correctAnswerId;
    const explanation = JSON.parse(form.dataset.explanation);

    const quizContainer = form.closest('.quiz-container');
    const selectedOption = form.querySelector(`input[name^='quiz_option_']:checked`);
    
    if (!selectedOption) {
      alert('Please select an answer.');
      return;
    }

    const feedbackContainer = quizContainer.querySelector('.feedback-container');
    const feedbackTitle = feedbackContainer.querySelector('.feedback-title');
    const feedbackSummary = feedbackContainer.querySelector('.feedback-summary');
    const feedbackBreakdown = feedbackContainer.querySelector('.feedback-breakdown');

    if (selectedOption.value === correctAnswerId) {
      feedbackTitle.textContent = '✅ Correct!';
      feedbackTitle.style.color = 'green';
    } else {
      feedbackTitle.textContent = '❌ Incorrect';
      feedbackTitle.style.color = 'red';
    }

    feedbackSummary.textContent = explanation.summary;
    feedbackBreakdown.innerHTML = '';
    explanation.breakdown.forEach(item => {
      const li = document.createElement('li');
      li.textContent = `${item.optionId}: ${item.reasoning}`;
      if (item.optionId === correctAnswerId) li.style.fontWeight = 'bold';
      if (item.optionId === selectedOption.value && selectedOption.value !== correctAnswerId) li.style.color = 'darkred';
      feedbackBreakdown.appendChild(li);
    });

    feedbackContainer.style.display = 'block';
  }

  function showQuizFromUrl() {
    const params = new URLSearchParams(window.location.search);
    const questionId = params.get('id');

    if (questionId) {
      const quizWrapper = document.getElementById(questionId);
      if (quizWrapper) {
        quizWrapper.style.display = 'block';
      } else {
        document.getElementById('quiz-not-found').style.display = 'block';
      }
    } else {
      document.getElementById('quiz-not-found').style.display = 'block';
    }
  }

  // Añadimos un único 'listener' al documento
  document.addEventListener('submit', handleQuizSubmit);
  // Ejecutamos la función para mostrar el quiz correcto al cargar la página
  document.addEventListener('DOMContentLoaded', showQuizFromUrl);
</script>
