---
/* src/components/LabEnvironment.astro */

const mermaidTopology = `
flowchart LR
    %% Nodes
    Cloud((LAN))
    
    subgraph LAN [L2 Management Bus]
        direction LR
        Switch([IP Fabric / Switch])
    end

    Terminal[terminal / bastion]
    Web[web-srv1]
    App[app-srv1]
    DB1[(data-001)]
    DB2[(data-002)]
    Docker[[docker-001]]
    KVM[[kvm-001]]

    %% Flow
    Cloud --- Switch
    Switch --- Terminal
    Switch --- Web
    Switch --- App
    Switch --- DB1
    Switch --- DB2
    Switch --- Docker
    Switch --- KVM

    %% Estilos de alto contraste y tama침o
    classDef default fill:#1e1e1e,stroke:#444,color:#e0e0e0,stroke-width:2px,font-size:14px
    classDef highlight fill:#1d3a52,stroke:#38bdf8,color:#fff,stroke-width:3px,font-size:14px
    classDef bus fill:#0b0e14,stroke:#333,color:#999,stroke-dasharray: 5 5
    
    class Terminal highlight
    class LAN bus
`;
---

<div class="lab-card">
  <div class="card-header">
    <span class="icon">游둲</span>
    <strong>Infrastructure Context</strong>
  </div>

  <div class="diagram-wrapper">
    <!-- Inyectamos el string corregido -->
    <pre class="mermaid" set:html={mermaidTopology} />
  </div>

  <div class="info-content">
    <p class="intro-text">
      Access via SSH from the <strong>Bastion Host (terminal)</strong>. The cluster
      topology is defined below:
    </p>
    
    <div class="terminal-window">
      <div class="terminal-bar">
        <span class="dot red"></span>
        <span class="dot yellow"></span>
        <span class="dot green"></span>
        <span class="terminal-title">游늯 /etc/hosts (Cluster Inventory)</span>
      </div>
      <div class="terminal-body">
        <pre><code>
<span class="comment"># Management & Controller</span>
10.0.0.15   terminal       <span class="comment"># Main Entry Point</span>

<span class="comment"># Web & Application Tier</span>
10.0.0.60   web-srv1   <span class="comment"># Nginx / Apache</span>
10.0.0.70   app-srv1    <span class="comment"># Backend App</span>

<span class="comment"># Data Persistence Tier</span>
10.0.0.80   data-001    <span class="comment"># Primary DB</span>
10.0.0.90   data-002    <span class="comment"># Replica / Backup</span>

<span class="comment"># Virtualization & Containers</span>
10.0.0.100  kvm-001        <span class="comment"># Libvirt Hypervisor</span>
10.0.0.110  docker-001     <span class="comment"># Container Runtime</span>
</code></pre>
      </div>
    </div>

    <div class="security-alert">
      <div class="alert-icon">丘멆잺</div>
      <div class="alert-text">
        <strong>Constraint:</strong> Nested SSH is forbidden. Connect directly from
        <code>terminal</code> to target IPs.
      </div>
    </div>
  </div>
</div>

<script>
  import mermaid from 'mermaid';
  mermaid.initialize({ 
    startOnLoad: true, 
    theme: 'dark',
    securityLevel: 'loose',
    flowchart: { 
      useMaxWidth: false, // Permitimos que el CSS controle el ancho
      htmlLabels: true,
      curve: 'stepBefore', // L칤neas tipo diagrama de red profesional
      nodeSpacing: 50,
      rankSpacing: 80
    }
  });
</script>

<style>
  .lab-card {
    border: 1px solid var(--sl-color-gray-5);
    background-color: var(--sl-color-gray-6);
    border-radius: 0.5rem;
    overflow: hidden;
    margin-bottom: 2rem;
  }

  .card-header {
    background-color: var(--sl-color-gray-5);
    padding: 0.6rem 1rem;
    font-size: 0.95rem;
    border-bottom: 1px solid var(--sl-color-gray-4);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
  }

  .diagram-wrapper {
    background-color: #0b0e14;
    padding: 3rem 1rem; /* M치s aire arriba y abajo */
    display: flex;
    justify-content: center;
    align-items: center;
    border-bottom: 1px solid var(--sl-color-gray-5);
    overflow-x: auto; /* Scroll si es muy ancho en m칩viles */
  }

  /* --- TRUCO DE ESCALADO --- */
  .diagram-wrapper :global(svg) {
    width: 100% !important; /* Fuerza a ocupar el ancho del card */
    height: auto !important;
    max-width: 900px; /* Tama침o m치ximo para que no se pixele el texto */
  }

  .mermaid {
    background: transparent !important;
    border: none !important;
  }

  .info-content { padding: 1.5rem; }
  .intro-text { font-size: 0.95rem; margin-bottom: 1.2rem; color: var(--sl-color-gray-2); }

  .terminal-window {
    background-color: #1e1e1e;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    border: 1px solid #333;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  }

  .terminal-bar {
    background-color: #2d2d2d;
    padding: 8px 12px;
    display: flex;
    align-items: center;
  }

  .dot { height: 12px; width: 12px; border-radius: 50%; margin-right: 8px; }
  .dot.red { background-color: #ff5f56; }
  .dot.yellow { background-color: #ffbd2e; }
  .dot.green { background-color: #27c93f; }

  .terminal-body { padding: 1.2rem; }

  pre {
    background: transparent !important;
    border: none !important;
    font-size: 0.9rem !important;
    line-height: 1.6;
  }

  .comment { color: #6a9955; }

  .security-alert {
    display: flex;
    align-items: center;
    gap: 1rem;
    background-color: rgba(234, 179, 8, 0.05);
    border: 1px solid var(--sl-color-orange-high);
    padding: 1rem;
    border-radius: 8px;
    color: var(--sl-color-orange-high);
  }
</style>