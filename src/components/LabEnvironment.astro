---
/* src/components/LabEnvironment.astro */

const mermaidTopology = `
flowchart TD
    Cloud((Internet))
    
    subgraph Backbone [L2 Management Bus]
        direction LR
        Switch([ ]) 
    end

    Terminal[terminal]
    Web[web-srv1]
    App[app-srv1]
    DB1[(data-001)]
    DB2[(data-002)]
    Docker[[docker-001]]
    KVM[[kvm-001]]

    Cloud --- Switch
    Switch --- Terminal
    Switch --- Web
    Switch --- App
    Switch --- DB1
    Switch --- DB2
    Switch --- Docker
    Switch --- KVM

    classDef default fill:#1e1e1e,stroke:#333,color:#e0e0e0,stroke-width:1px
    classDef highlight fill:#234,stroke:#38bdf8,color:#fff,stroke-width:2px
    classDef netBus fill:none,stroke:#444,stroke-dasharray:5
    
    class Terminal highlight
    class Backbone netBus
`;
---

<div class="lab-card">
  <div class="card-header">
    <span class="icon">üñß</span>
    <strong>Infrastructure Context</strong>
  </div>

  <div class="diagram-wrapper">
    <!-- Usamos set:html para asegurar que Astro no escape caracteres -->
    <pre class="mermaid" set:html={mermaidTopology} />
  </div>

  <div class="info-content">
    <p class="intro-text">
      Access via SSH from the <strong>Bastion Host (terminal)</strong>. The cluster
      topology is defined below:
    </p>
    
    <div class="terminal-window">
      <div class="terminal-bar">
        <span class="dot red"></span>
        <span class="dot yellow"></span>
        <span class="dot green"></span>
        <span class="terminal-title">üìÑ /etc/hosts (Cluster Inventory)</span>
      </div>
      <div class="terminal-body">
        <pre><code>
<span class="comment"># Management & Controller</span>
10.0.0.15   terminal       <span class="comment"># Main Entry Point</span>

<span class="comment"># Web & Application Tier</span>
10.0.0.60   web-srv1   <span class="comment"># Nginx / Apache</span>
10.0.0.70   app-srv1    <span class="comment"># Backend App</span>

<span class="comment"># Data Persistence Tier</span>
10.0.0.80   data-001    <span class="comment"># Primary DB</span>
10.0.0.90   data-002    <span class="comment"># Replica / Backup</span>

<span class="comment"># Virtualization & Containers</span>
10.0.0.100  kvm-001        <span class="comment"># Libvirt Hypervisor</span>
10.0.0.110  docker-001     <span class="comment"># Container Runtime</span>
</code></pre>
      </div>
    </div>

    <div class="security-alert">
      <div class="alert-icon">‚ö†Ô∏è</div>
      <div class="alert-text">
        <strong>Constraint:</strong> Nested SSH is forbidden. Connect directly from
        <code>terminal</code> to target IPs.
      </div>
    </div>
  </div>
</div>

<script>
  import mermaid from 'mermaid';
  mermaid.initialize({ 
    startOnLoad: true, 
    theme: 'dark',
    // Esta opci√≥n es cr√≠tica para que acepte estilos CSS personalizados
    securityLevel: 'loose', 
    flowchart: { 
      useMaxWidth: true, 
      htmlLabels: true,
      curve: 'basis' 
    }
  });
</script>

<style>
  .lab-card {
    border: 1px solid var(--sl-color-gray-5);
    background-color: var(--sl-color-gray-6);
    border-radius: 0.5rem;
    overflow: hidden;
    margin-bottom: 2rem;
  }

  .card-header {
    background-color: var(--sl-color-gray-5);
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    border-bottom: 1px solid var(--sl-color-gray-4);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: var(--sl-color-white);
  }

  .diagram-wrapper {
    background-color: #0b0e14;
    padding: 2rem 1rem;
    display: flex;
    justify-content: center;
    border-bottom: 1px solid var(--sl-color-gray-5);
    min-height: 350px;
  }

  /* Forzamos que el contenedor no rompa el estilo de Mermaid */
  .mermaid {
    background: transparent !important;
    border: none !important;
    color: inherit;
  }

  .info-content { padding: 1.2rem; }
  .intro-text { font-size: 0.9rem; color: var(--sl-color-gray-2); margin-bottom: 1rem; }

  .terminal-window {
    background-color: #1e1e1e;
    border-radius: 6px;
    margin-bottom: 1.5rem;
    border: 1px solid #333;
    overflow: hidden;
  }

  .terminal-bar {
    background-color: #2d2d2d;
    padding: 6px 10px;
    display: flex;
    align-items: center;
  }

  .dot { height: 10px; width: 10px; border-radius: 50%; margin-right: 6px; }
  .dot.red { background-color: #ff5f56; }
  .dot.yellow { background-color: #ffbd2e; }
  .dot.green { background-color: #27c93f; }

  .terminal-body { padding: 1rem; overflow-x: auto; }

  pre {
    background: transparent !important;
    border: none !important;
    font-size: 0.85rem;
  }

  .comment { color: #6a9955; font-style: italic; }

  .security-alert {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    background-color: var(--sl-color-orange-low); 
    border: 1px solid var(--sl-color-orange-high);
    padding: 0.75rem;
    border-radius: 6px;
    color: var(--sl-color-orange-high);
    font-size: 0.85rem;
  }
</style>