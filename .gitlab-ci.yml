# .gitlab-ci.yml

# 1. Usa una versión de Node.js específica y moderna, que coincida con tu entorno local.
#    Evita 'latest' para tener builds predecibles. 'node:22' o 'node:20' son buenas opciones.
image: node:22

# 2. Define una caché para acelerar las instalaciones futuras.
#    Esto guarda la carpeta 'node_modules' entre ejecuciones de la pipeline.
cache:
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/

# 3. Define el trabajo 'pages' para el despliegue en GitLab Pages.
pages:
  stage: deploy
  script:
    # 3.1. Instala dependencias. Si la caché existe, será mucho más rápido.
    - npm install
    
    # 3.2. Ejecuta el build de Astro.
    - npm run build
    
    # 3.3. Elimina la carpeta 'public' original del repositorio para evitar anidamiento.
    #      Este es el paso crucial que descubrimos.
    - rm -rf public
    
    # 3.4. Renombra la carpeta 'dist' (generada por el build) a 'public'.
    #      Ahora es un renombrado limpio porque 'public' ya no existe.
    - mv dist public
    
  artifacts:
    # 3.5. Define la carpeta 'public' como el artefacto a desplegar.
    paths:
      - public
      
  # 4. Ejecuta este trabajo solo en la rama principal.
  only:
    - main
