## Introductory Tutorial to `iptables`

iptables is a command-line application that allows a system administrator to configure the Linux kernel's firewall (Netfilter). It works by inspecting network packets
and deciding what to do with them based on a set of rules.

### Core Concepts

To understand iptables, you need to know three key concepts: Tables, Chains, and Rules.

 1. Tables: These are containers for rules designed for a specific purpose. The most common one, and the one we'll use here, is the filter table.
     * filter: This is the default table and is used to decide whether a packet should be allowed or not.
     * Other tables include nat (for rewriting addresses) and mangle (for altering packets).

 2. Chains: These are checkpoints within a table where rules are applied. In the filter table, the three main chains are:
     * INPUT: For packets destined for the system itself.
     * OUTPUT: For packets generated by the system itself and leaving it.
     * FORWARD: For packets that pass through the system (i.e., the system is acting as a router).

 3. Rules: These are the instructions that tell iptables what to do. A rule specifies criteria (e.g., "if the packet is TCP and going to port 22") and an action or
    "target."

 4. Actions/Targets: The action to take if a packet matches a rule. The most common are:
     * ACCEPT: Allow the packet to pass.
     * DROP: Silently discard the packet. The sender receives no response.
     * REJECT: Reject the packet and notify the sender with an error.

---

### Basic `iptables` Commands

Warning! Be very careful when configuring iptables, especially on a remote server. An incorrect rule could block your own access (e.g., via SSH).

 1. List the Current Rules:
    This is the safest and most useful command to start with. It shows all the rules in the filter table.

 1     sudo iptables -L

    For a more detailed view, with packet counts and in numeric format (without resolving host or port names):

 1     sudo iptables -L -v -n

 2. Set the Default Policy:
    A good security practice is to block everything by default and only allow what is explicitly necessary.

 1     # Block all incoming traffic by default
 2     sudo iptables -P INPUT DROP
 3 
 4     # Block all traffic passing through the system
 5     sudo iptables -P FORWARD DROP
 6 
 7     # (Optional) Allow all outgoing traffic
 8     sudo iptables -P OUTPUT ACCEPT
    If you run sudo iptables -P INPUT DROP without first adding a rule to allow your SSH connection, you will lose access!

 3. Append a Rule:
    The -A flag adds a rule to the end of a chain.

 1     # Allow incoming SSH connections
 2     sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
     * -A INPUT: Appends the rule to the INPUT chain.
     * -p tcp: Specifies that the rule is for the TCP protocol.
     * --dport 22: Specifies the destination port, in this case, 22 (SSH).
     * -j ACCEPT: The action to take is ACCEPT.

 4. Flush All Rules:
    To start from scratch, you can delete all rules in a chain or in all chains.

 1     # Flush all rules in the INPUT chain
 2     sudo iptables -F INPUT
 3 
 4     # Flush ALL rules in the filter table
 5     sudo iptables -F

 5. Delete a Specific Rule:
    You can delete a rule by specifying it exactly as you created it or by its line number.

 1     # Delete by specification
 2     sudo iptables -D INPUT -p tcp --dport 22 -j ACCEPT
 3 
 4     # Delete by line number (first, list the rules with --line-numbers)
 5     sudo iptables -L --line-numbers
 6     sudo iptables -D INPUT 1  # Deletes rule number 1 from the INPUT chain

---

Practical Example: Configuring a Basic Firewall for a Web Server

This is a common and secure set of rules for a web server that only needs to serve HTTP/HTTPS traffic and allow SSH access.

  1 #!/bin/bash
  2 
  3 # 1. Flush all existing rules to start from scratch
  4 sudo iptables -F
  5 sudo iptables -X # Delete custom chains
  6 
  7 # 2. Set default policies: Block anything not explicitly allowed
  8 sudo iptables -P INPUT   DROP
  9 sudo iptables -P FORWARD DROP
 10 sudo iptables -P OUTPUT  ACCEPT # We allow outgoing traffic
 11 
 12 # 3. Allow loopback traffic (VERY IMPORTANT!)
 13 # The system needs to communicate with itself
 14 sudo iptables -A INPUT -i lo -j ACCEPT
 15 
 16 # 4. Allow established and related connections
 17 # This is the MOST IMPORTANT rule. It allows return traffic for connections
 18 # that the server itself initiated. Without it, nothing would work.
 19 sudo iptables -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
 20 
 21 # 5. Allow specific services
 22 # Allow SSH access (port 22)
 23 sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
 24 
 25 # Allow HTTP access (port 80)
 26 sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
 27 
 28 # Allow HTTPS access (port 443)
 29 sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT
 30 
 31 # Optional: Limit SSH access to a specific IP for greater security
 32 # sudo iptables -A INPUT -p tcp -s YOUR_IP_HERE --dport 22 -j ACCEPT

---

Making Rules Permanent (Persistence)

iptables rules are lost every time the system reboots. To make them permanent, the method varies depending on the Linux distribution:

 * On Debian/Ubuntu (Recommended method):
    Use the iptables-persistent package.

 1     sudo apt-get update
 2     sudo apt-get install iptables-persistent
    During the installation, it will ask if you want to save the current IPv4 and IPv6 rules. Say yes. If you change the rules later, run this command to save them:

 1     sudo netfilter-persistent save

 * On RHEL/CentOS/Fedora:
    Use iptables-services.

 1     sudo dnf install iptables-services
 2     sudo systemctl enable iptables
 3     sudo service iptables save # Saves the current rules

This tutorial covers the fundamentals. iptables is extremely powerful and allows for the creation of very complex rules, but with these commands, you can already build a
 very effective firewall.
